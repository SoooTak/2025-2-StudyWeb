<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>세션/출석 테스트</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 20px; }
    .card { border:1px solid #ddd; border-radius:10px; padding:12px; margin:12px 0; }
    label { display:inline-block; min-width:120px; }
    input, button { padding:6px 8px; margin:6px 0; }
    .ok { color:#0a0; } .err { color:#b00; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  </style>
</head>
<body>
  <h1>세션/출석 테스트</h1>

  <div class="card">
    <h3>세션 생성 (리더/공동리더만)</h3>
    <div>
      <label>studyId</label><input id="c_studyId" type="number" value="4" min="1"><br/>
      <label>title</label><input id="c_title" placeholder="주간 회의"><br/>
      <label>startAt</label><input id="c_start" type="datetime-local"><br/>
      <label>endAt</label><input id="c_end" type="datetime-local"><br/>
      <label>useAttendance</label><input id="c_use" type="checkbox" checked><br/>
      <label>mode</label><input id="c_mode" value="SELF"><br/>
      <label>openOffsetMinutes</label><input id="c_open" type="number" value="10"><br/>
      <label>closeOffsetMinutes</label><input id="c_close" type="number" value="20"><br/>
      <button id="btnCreate">생성</button>
      <span id="c_msg"></span>
    </div>
  </div>

  <div class="card">
    <h3>세션 목록</h3>
    <div>
      <label>studyId</label><input id="l_studyId" type="number" value="4" min="1">
      <button id="btnList">불러오기</button>
    </div>
    <table>
      <thead><tr><th>id</th><th>title</th><th>start</th><th>end</th></tr></thead>
      <tbody id="listBody"><tr><td colspan="4">대기 중…</td></tr></tbody>
    </table>
  </div>

  <div class="card">
    <h3>내 출석</h3>
    <div>
      <label>sessionId</label><input id="a_sessionId" type="number" min="1">
      <button id="btnMy">내 출석 조회</button>
      <button id="btnSelf">SELF 출석</button>
      <span id="a_msg"></span>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);

    $('#btnCreate').onclick = async () => {
      const studyId = Number($('#c_studyId').value);
      const body = {
        title: $('#c_title').value || '주간 회의',
        startAt: $('#c_start').value ? new Date($('#c_start').value).toISOString() : null,
        endAt: $('#c_end').value ? new Date($('#c_end').value).toISOString() : null,
        useAttendance: $('#c_use').checked,
        mode: $('#c_mode').value || 'SELF',
        openOffsetMinutes: Number($('#c_open').value || 0),
        closeOffsetMinutes: Number($('#c_close').value || 0),
      };
      $('#c_msg').textContent = '';
      try {
        const r = await fetch(`/api/studies/${studyId}/sessions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (!r.ok) throw new Error(`HTTP ${r.status}: ` + await r.text());
        const data = await r.json();
        $('#c_msg').textContent = `생성 성공 (id=${data.id})`;
        $('#c_msg').className = 'ok';
        $('#a_sessionId').value = data.id;
      } catch (e) {
        $('#c_msg').textContent = e.message;
        $('#c_msg').className = 'err';
      }
    };

    $('#btnList').onclick = async () => {
      const studyId = Number($('#l_studyId').value);
      const body = $('#listBody');
      body.innerHTML = '<tr><td colspan="4">불러오는 중…</td></tr>';
      try {
        const r = await fetch(`/api/studies/${studyId}/sessions`);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        const items = data.items || [];
        if (items.length === 0) {
          body.innerHTML = '<tr><td colspan="4">세션 없음</td></tr>';
          return;
        }
        body.innerHTML = '';
        for (const s of items) {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${s.id}</td><td>${s.title}</td><td>${(s.startAt||'').replace('T',' ')}</td><td>${(s.endAt||'').replace('T',' ')}</td>`;
          body.appendChild(tr);
        }
      } catch (e) {
        body.innerHTML = `<tr><td colspan="4">오류: ${e.message}</td></tr>`;
      }
    };

    $('#btnMy').onclick = async () => {
      const sid = Number($('#a_sessionId').value);
      $('#a_msg').textContent = '';
      try {
        const r = await fetch(`/api/sessions/${sid}/attendance/my`);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        $('#a_msg').textContent = data.has ? `상태=${data.status} (markedAt=${data.markedAt||'-'})` : '출석기록 없음';
        $('#a_msg').className = 'ok';
      } catch (e) {
        $('#a_msg').textContent = e.message;
        $('#a_msg').className = 'err';
      }
    };

    $('#btnSelf').onclick = async () => {
      const sid = Number($('#a_sessionId').value);
      $('#a_msg').textContent = '';
      try {
        const r = await fetch(`/api/sessions/${sid}/attendance/self`, { method: 'POST' });
        const text = await r.text();
        if (!r.ok) throw new Error(`HTTP ${r.status}: ${text}`);
        const data = JSON.parse(text);
        $('#a_msg').textContent = `SELF 완료: ${data.result} (attendanceId=${data.attendanceId})`;
        $('#a_msg').className = 'ok';
      } catch (e) {
        $('#a_msg').textContent = e.message;
        $('#a_msg').className = 'err';
      }
    };
  </script>
</body>
</html>
